<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bf.unierp.customer.mapper.UniErpCustomerMapper">

	<!-- UNIERP 이전설치 본인인증 후 구매/렌탈 리스트 조회 -->
	<select id="selectMyRentalListUNIERP_info" parameterType="HashMap" resultType="Hashmap">
		/****************[unierp_customer.selectMyRentalListUNIERP_info]****************/
		SELECT
		DISTINCT
		INFO.orderNo			AS orderNo
		, INFO.contNo			AS contNo
		, INFO.custNo			AS custNo
		, INFO.custName			AS custName
		, INFO.custMobile		AS custMobile
		, INFO.modelCode		AS modelCode
		, INFO.erpModelName		AS erpModelName
		, INFO.saleKind			AS saleKind
		, INFO.saleKindName		AS saleKindName
		, INFO.rentalTerm		AS rentalTerm
		, INFO.rentalTerm		AS serviceMonth
		, INFO.asMonth			AS asMonth
		, INFO.usedTerm			AS usedTerm
		, INFO.receipt			AS receipt
		, INFO.monthlyPayDay	AS monthlyPayDay
		, INFO.bankCd			AS bankCd
		, INFO.acctNo			AS acctNo
		, INFO.acctNo			AS bankNo
		, INFO.bankNm			AS bankNm
		, INFO.payMeth			AS payMeth
		, INFO.panGubun			AS panGubun
		, INFO.instPost			AS instPost
		, INFO.instAddr1		AS instAddr1
		, INFO.instAddr2		AS instAddr2
		, INFO.instTel			AS instTel
		, INFO.instMobile		AS instMobile
		, INFO.instCustName		AS instCustName
		, INFO.outcom			AS outcom
		, INFO.instreserv		AS instreserv
		, INFO.custKind
		, INFO.custKind			AS grpCode
		, CONVERT(VARCHAR(10), INFO.installDate, 121) 		AS installDate
		, CONVERT(VARCHAR(10), INFO.freeAsStartDate, 121) 	AS freeAsStartDate
		, CONVERT(VARCHAR(10), INFO.freeAsEndDate, 121)		AS freeAsEndDate
		, CONVERT(VARCHAR(10), INFO.rentalStartDate, 121)	AS rentalStartDate
		, CONVERT(VARCHAR(10), INFO.rentalEndDate, 121)		AS rentalEndDate
		, CONVERT(INT, INFO.rentalPrice1)					AS rentalPrice1
		, CONVERT(INT, INFO.rentalPrice2)					AS rentalPrice2
		, CONVERT(INT, INFO.totRentalPrice)					AS totRentalPrice
		, CONVERT(INT, INFO.prepayments)					AS prepayments
		FROM   (
		SELECT
		OC.ORDER_NO	orderNo
		, OC.CONT_NO			contNo
		, OC.CUST_NO			custNo
		, CS.CUST_NM			custName
		, UNIERP5.dbo.FN_DEC(CS.HAND_TEL_NO)		custMobile
		, OA.CONT_DT			installDate
		, OC.GOODS_CD			modelCode
		, OC.GOODS_NM			erpModelName
		, OC.SALES_KIND			saleKind
		, M1.MINOR_NM			saleKindName
		, OC.RND1_RENTAL_AMT	rentalPrice1
		, OC.RND2_RENTAL_AMT	rentalPrice2
		, OC.RND1_PAY_AMT		totRentalPrice
		, OC.PREPAY_AMT			prepayments
		, OP.PAY_METH			receipt
		, OP.MONTHLY_PAY_DAY	monthlyPayDay
		, OP.BANK_CD			bankCd
		, CASE WHEN OP.PAY_METH = '1' THEN CC.CARD_CO_NM
		ELSE BK.BANK_NM
		END AS bankNm
		, CASE WHEN OP.PAY_METH = '1' THEN '신용카드'
		WHEN OP.PAY_METH = '2' THEN 'CMS'
		WHEN OP.PAY_METH = '3' THEN '가상계좌'
		WHEN OP.PAY_METH = '4' THEN '지로'
		WHEN OP.PAY_METH = '5' THEN '가수금'
		WHEN OP.PAY_METH = '6' THEN '법인계좌'
		WHEN OP.PAY_METH = '7' THEN '선입금'
		WHEN OP.PAY_METH = '8' THEN '연체입금'
		WHEN OP.PAY_METH = '9' THEN '일반(현금)'
		ELSE OP.PAY_METH
		END AS payMeth
		, REPLICATE('*', LEN(RENTAL.dbo.FN_DEC(OP.ACCT_NO))-4) + RIGHT(RENTAL.dbo.FN_DEC(OP.ACCT_NO), 4) acctNo
		, M2.MINOR_NM			GIRONAME
		, OC.RENTAL_PERIOD		rentalTerm
		, OC.RENTAL_PERIOD		serviceMonth
		, OC.AS_PERIOD			asMonth
		, CASE WHEN (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) >= OC.RENTAL_PERIOD THEN OC.RENTAL_PERIOD ELSE (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) END usedTerm
		, OC.CONT_STS			panGubun
		, M3.MINOR_NM			PAN_GUBUN_NAME
		, OC.RENTAL_FR_DT		freeAsStartDate
		, CASE WHEN ISNUMERIC(OC.AS_PERIOD) = 1 THEN DATEADD(M, OC.AS_PERIOD, OA.CONT_DT - 1) ELSE OC.RENTAL_TO_DT END freeAsEndDate
		, OC.RENTAL_FR_DT		rentalStartDate
		, OC.RENTAL_TO_DT		rentalEndDate
		, CASE WHEN OC.ITEM_GROUP_BIG LIKE 'A%' THEN 'M'	-- chair
		WHEN OC.ITEM_GROUP_BIG LIKE 'L%' THEN 'L'	-- lacloud
		WHEN OC.ITEM_GROUP_BIG LIKE 'W%' THEN 'W'	-- Water
		WHEN OC.ITEM_GROUP_BIG LIKE 'B%' THEN 'G'	-- BTN GLED
		WHEN OC.ITEM_GROUP_BIG = 'U11000' THEN 'BB'	-- 생활가전 블롬베르크
		ELSE OC.ITEM_GROUP_BIG
		END custKind
		, OI.INSTL_ZIP_CD		instPost
		, CONCAT(OI.INSTL_ADDR1, ' ', OI.INSTL_ADDR2, ' ', OI.INSTL_ADDR3) instAddr1
		, OI.INSTL_ADDR4		instAddr2
		, UNIERP5.DBO.FN_DEC(OI.INSTL_TEL_NO)		instTel
		, UNIERP5.DBO.FN_DEC(OI.INSTL_HAND_TEL_NO)	instMobile
		, OI.INSTL_CUST_NM		instCustName
		, CASE WHEN OA.CONT_DT IS NOT NULL THEN '2' ELSE '0' END instreserv
		, OP.WD_CD              outcom
		,
		(select TOP 1 COLLECT_AMT FROM RENTAL.DBO.R_CONTRACT_RENTAL_SCHD WITH (NOLOCK) WHERE ORDER_NO = OC.ORDER_NO
		and PAY_FLAG = 'Y' ORDER BY RND_NO DESC) lastOutPayPrice
		FROM RENTAL.DBO.R_ORDER_CONTRACT				OC  (NOLOCK)
		LEFT JOIN RENTAL.DBO.R_ORDER_INSTALL		OI  (NOLOCK) ON (OI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_CONTRACT_ADD	OA  (NOLOCK) ON (OA.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M1  (NOLOCK) ON (M1.MAJOR_CD = 'R1001' AND M1.MINOR_CD = OC.SALES_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_PAYMENT		OP  (NOLOCK) ON (OP.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_BANK 				BK  (NOLOCK) ON (OP.BANK_CD = BK.BANK_CD)
		LEFT JOIN UNIERP5.DBO.B_CARD_CO 			CC  (NOLOCK) ON (OP.BANK_CD = CC.CARD_CO_CD)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M2  (NOLOCK) ON (M2.MAJOR_CD = 'R3011' AND M2.MINOR_CD = OP.PAY_METH)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M3  (NOLOCK) ON (M3.MAJOR_CD = 'R3100' AND M3.MINOR_CD = OC.CONT_STS)
		LEFT JOIN RENTAL.DBO.R_CUSTOMER				CS  (NOLOCK) ON (CS.CUST_NO = OC.CUST_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M4  (NOLOCK) ON (M4.MAJOR_CD = 'R2001' AND M4.MINOR_CD = CS.CUST_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_ITEM           RI  (NOLOCK) ON (OC.ORDER_NO = RI.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_RENTAL_INFO    ORI (NOLOCK) ON (ORI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.V_ORDER_KEY 			VOK WITH(NOEXPAND) ON (VOK.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN (SELECT DISTINCT ORDER_NO  FROM RENTAL.DBO.R_WD_CMS_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CMSR  ON VOK.ORDER_NO = CMSR.ORDER_NO
		LEFT JOIN (SELECT DISTINCT ORDER_NO FROM RENTAL.DBO.R_WD_CARD_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CARDR  ON VOK.ORDER_NO = CARDR.ORDER_NO
		WHERE
		OA.APROV_DT IS NOT NULL	-- 승인일
		AND OC.CONT_STS NOT IN ('36', '40', '42', '43', '47', '55', '75', '80')	-- 계약상태 (해지, 환불, ...)
		AND ISNULL(OC.ORDER_STS, '') NOT IN ('37', '45', 'Z5')
		AND OC.SALES_GRP NOT IN ('1050', '2005', '1054', '1051') -- 롯데하이마트, 쿠팡, 전자랜드, 방방 고객 아닌것
		AND CS.CUST_NM LIKE CONCAT('%', #{name}, '%')
		AND (CS.TEL_NO = RENTAL.DBO.FN_ENC(#{phone}) OR CS.HAND_TEL_NO = RENTAL.DBO.FN_ENC(#{phone}))
		AND ((OC.ITEM_GROUP_BIG LIKE 'A%' OR OC.ITEM_GROUP_BIG LIKE 'L%' OR OC.ITEM_GROUP_BIG LIKE 'W%' OR OC.ITEM_GROUP_BIG = 'U10000') OR (OC.ITEM_GROUP_BIG LIKE 'B%' AND OC.GOODS_NM LIKE '%GLED%'))
		UNION ALL
		SELECT
		OC.ORDER_NO	orderNo
		, OC.CONT_NO			contNo
		, OC.CUST_NO			custNo
		, OI.INSTL_CUST_NM			custName
		, UNIERP5.dbo.FN_DEC(OI.INSTL_HAND_TEL_NO)		custMobile
		, OA.CONT_DT			installDate
		, OC.GOODS_CD			modelCode
		, OC.GOODS_NM			erpModelName
		, OC.SALES_KIND			saleKind
		, M1.MINOR_NM			saleKindName
		, OC.RND1_RENTAL_AMT	rentalPrice1
		, OC.RND2_RENTAL_AMT	rentalPrice2
		, OC.RND1_PAY_AMT		totRentalPrice
		, OC.PREPAY_AMT			prepayments
		, OP.PAY_METH			receipt
		, OP.MONTHLY_PAY_DAY	monthlyPayDay
		, OP.BANK_CD			bankCd
		, CASE WHEN OP.PAY_METH = '1' THEN CC.CARD_CO_NM
		ELSE BK.BANK_NM
		END AS bankNm
		, CASE WHEN OP.PAY_METH = '1' THEN '신용카드'
		WHEN OP.PAY_METH = '2' THEN 'CMS'
		WHEN OP.PAY_METH = '3' THEN '가상계좌'
		WHEN OP.PAY_METH = '4' THEN '지로'
		WHEN OP.PAY_METH = '5' THEN '가수금'
		WHEN OP.PAY_METH = '6' THEN '법인계좌'
		WHEN OP.PAY_METH = '7' THEN '선입금'
		WHEN OP.PAY_METH = '8' THEN '연체입금'
		WHEN OP.PAY_METH = '9' THEN '일반(현금)'
		ELSE OP.PAY_METH
		END AS payMeth
		, REPLICATE('*', LEN(RENTAL.dbo.FN_DEC(OP.ACCT_NO))-4) + RIGHT(RENTAL.dbo.FN_DEC(OP.ACCT_NO), 4) acctNo
		, M2.MINOR_NM			GIRONAME
		, OC.RENTAL_PERIOD		rentalTerm
		, OC.RENTAL_PERIOD		serviceMonth
		, OC.AS_PERIOD			asMonth
		, CASE WHEN (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) >= OC.RENTAL_PERIOD THEN OC.RENTAL_PERIOD ELSE (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) END usedTerm
		, OC.CONT_STS			panGubun
		, M3.MINOR_NM			PAN_GUBUN_NAME
		, OC.RENTAL_FR_DT		freeAsStartDate
		, CASE WHEN ISNUMERIC(OC.AS_PERIOD) = 1 THEN DATEADD(M, OC.AS_PERIOD, OA.CONT_DT - 1) ELSE OC.RENTAL_TO_DT END freeAsEndDate
		, OC.RENTAL_FR_DT		rentalStartDate
		, OC.RENTAL_TO_DT		rentalEndDate
		, CASE WHEN OC.ITEM_GROUP_BIG LIKE 'A%' THEN 'M'	-- chair
		WHEN OC.ITEM_GROUP_BIG LIKE 'L%' THEN 'L'	-- lacloud
		WHEN OC.ITEM_GROUP_BIG LIKE 'W%' THEN 'W'	-- Water
		WHEN OC.ITEM_GROUP_BIG LIKE 'B%' THEN 'G'	-- BTN GLED
		WHEN OC.ITEM_GROUP_BIG = 'U11000' THEN 'BB'	-- 생활가전 블롬베르크
		ELSE OC.ITEM_GROUP_BIG
		END custKind
		, OI.INSTL_ZIP_CD		instPost
		, CONCAT(OI.INSTL_ADDR1, ' ', OI.INSTL_ADDR2, ' ', OI.INSTL_ADDR3) instAddr1
		, OI.INSTL_ADDR4		instAddr2
		, UNIERP5.DBO.FN_DEC(OI.INSTL_TEL_NO)		instTel
		, UNIERP5.DBO.FN_DEC(OI.INSTL_HAND_TEL_NO)	instMobile
		, OI.INSTL_CUST_NM		instCustName
		, CASE WHEN OA.CONT_DT IS NOT NULL THEN '2' ELSE '0' END instreserv
		, OP.WD_CD              outcom
		,
		(select TOP 1 COLLECT_AMT FROM RENTAL.DBO.R_CONTRACT_RENTAL_SCHD WITH (NOLOCK) WHERE ORDER_NO = OC.ORDER_NO
		and PAY_FLAG = 'Y' ORDER BY RND_NO DESC) lastOutPayPrice
		FROM RENTAL.DBO.R_ORDER_CONTRACT				OC  (NOLOCK)
		LEFT JOIN RENTAL.DBO.R_ORDER_INSTALL		OI  (NOLOCK) ON (OI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_CONTRACT_ADD	OA  (NOLOCK) ON (OA.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M1  (NOLOCK) ON (M1.MAJOR_CD = 'R1001' AND M1.MINOR_CD = OC.SALES_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_PAYMENT		OP  (NOLOCK) ON (OP.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_BANK 				BK  (NOLOCK) ON (OP.BANK_CD = BK.BANK_CD)
		LEFT JOIN UNIERP5.DBO.B_CARD_CO 			CC  (NOLOCK) ON (OP.BANK_CD = CC.CARD_CO_CD)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M2  (NOLOCK) ON (M2.MAJOR_CD = 'R3011' AND M2.MINOR_CD = OP.PAY_METH)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M3  (NOLOCK) ON (M3.MAJOR_CD = 'R3100' AND M3.MINOR_CD = OC.CONT_STS)
		LEFT JOIN RENTAL.DBO.R_CUSTOMER				CS  (NOLOCK) ON (CS.CUST_NO = OC.CUST_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M4  (NOLOCK) ON (M4.MAJOR_CD = 'R2001' AND M4.MINOR_CD = CS.CUST_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_ITEM           RI  (NOLOCK) ON (OC.ORDER_NO = RI.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_RENTAL_INFO    ORI (NOLOCK) ON (ORI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.V_ORDER_KEY 			VOK WITH(NOEXPAND) ON (VOK.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN (SELECT DISTINCT ORDER_NO  FROM RENTAL.DBO.R_WD_CMS_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CMSR  ON VOK.ORDER_NO = CMSR.ORDER_NO
		LEFT JOIN (SELECT DISTINCT ORDER_NO FROM RENTAL.DBO.R_WD_CARD_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CARDR  ON VOK.ORDER_NO = CARDR.ORDER_NO
		WHERE
		OA.APROV_DT IS NOT NULL	-- 승인일
		AND OC.CONT_STS NOT IN ('36', '40', '42', '43', '47', '55', '75', '80')	-- 계약상태 (해지, 환불, ...)
		AND ISNULL(OC.ORDER_STS, '') NOT IN ('37', '45', 'Z5')
		AND OC.SALES_GRP NOT IN ('1050', '2005', '1054', '1051') -- 롯데하이마트, 쿠팡, 전자랜드, 방방 고객 아닌것
		AND OI.INSTL_CUST_NM LIKE CONCAT('%', #{name}, '%')
		AND (OI.INSTL_TEL_NO = RENTAL.DBO.FN_ENC(#{phone}) OR OI.INSTL_HAND_TEL_NO = RENTAL.DBO.FN_ENC(#{phone}))
		AND ((OC.ITEM_GROUP_BIG LIKE 'A%' OR OC.ITEM_GROUP_BIG LIKE 'L%' OR OC.ITEM_GROUP_BIG LIKE 'W%' OR OC.ITEM_GROUP_BIG = 'U10000') OR (OC.ITEM_GROUP_BIG LIKE 'B%' AND OC.GOODS_NM LIKE '%GLED%'))
		UNION ALL
		/* 하이마트, 쿠팡, 전자랜드, 방방 */
		SELECT
		OC.ORDER_NO	orderNo
		, OC.CONT_NO			contNo
		, OC.CUST_NO			custNo
		, OI.INSTL_CUST_NM			custName
		, UNIERP5.dbo.FN_DEC(OI.INSTL_HAND_TEL_NO)		custMobile
		, OA.CONT_DT			installDate
		, OC.GOODS_CD			modelCode
		, OC.GOODS_NM			erpModelName
		, OC.SALES_KIND			saleKind
		, M1.MINOR_NM			saleKindName
		, OC.RND1_RENTAL_AMT	rentalPrice1
		, OC.RND2_RENTAL_AMT	rentalPrice2
		, OC.RND1_PAY_AMT		totRentalPrice
		, OC.PREPAY_AMT			prepayments
		, OP.PAY_METH			receipt
		, OP.MONTHLY_PAY_DAY	monthlyPayDay
		, OP.BANK_CD			bankCd
		, CASE WHEN OP.PAY_METH = '1' THEN CC.CARD_CO_NM
		ELSE BK.BANK_NM
		END AS bankNm
		, CASE WHEN OP.PAY_METH = '1' THEN '신용카드'
		WHEN OP.PAY_METH = '2' THEN 'CMS'
		WHEN OP.PAY_METH = '3' THEN '가상계좌'
		WHEN OP.PAY_METH = '4' THEN '지로'
		WHEN OP.PAY_METH = '5' THEN '가수금'
		WHEN OP.PAY_METH = '6' THEN '법인계좌'
		WHEN OP.PAY_METH = '7' THEN '선입금'
		WHEN OP.PAY_METH = '8' THEN '연체입금'
		WHEN OP.PAY_METH = '9' THEN '일반(현금)'
		ELSE OP.PAY_METH
		END AS payMeth
		, REPLICATE('*', LEN(RENTAL.dbo.FN_DEC(OP.ACCT_NO))-4) + RIGHT(RENTAL.dbo.FN_DEC(OP.ACCT_NO), 4) acctNo
		, M2.MINOR_NM			GIRONAME
		, OC.RENTAL_PERIOD		rentalTerm
		, OC.RENTAL_PERIOD		serviceMonth
		, OC.AS_PERIOD			asMonth
		, CASE WHEN (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) >= OC.RENTAL_PERIOD THEN OC.RENTAL_PERIOD ELSE (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) END usedTerm
		, OC.CONT_STS			panGubun
		, M3.MINOR_NM			PAN_GUBUN_NAME
		, OC.RENTAL_FR_DT		freeAsStartDate
		, CASE WHEN ISNUMERIC(OC.AS_PERIOD) = 1 THEN DATEADD(M, OC.AS_PERIOD, OA.CONT_DT - 1) ELSE OC.RENTAL_TO_DT END freeAsEndDate
		, OC.RENTAL_FR_DT		rentalStartDate
		, OC.RENTAL_TO_DT		rentalEndDate
		, CASE WHEN OC.ITEM_GROUP_BIG LIKE 'A%' THEN 'M'	-- chair
		WHEN OC.ITEM_GROUP_BIG LIKE 'L%' THEN 'L'	-- lacloud
		WHEN OC.ITEM_GROUP_BIG LIKE 'W%' THEN 'W'	-- Water
		WHEN OC.ITEM_GROUP_BIG LIKE 'B%' THEN 'G'	-- BTN GLED
		WHEN OC.ITEM_GROUP_BIG = 'U11000' THEN 'BB'	-- 생활가전 블롬베르크
		ELSE OC.ITEM_GROUP_BIG
		END custKind
		, OI.INSTL_ZIP_CD		instPost
		, CONCAT(OI.INSTL_ADDR1, ' ', OI.INSTL_ADDR2, ' ', OI.INSTL_ADDR3) instAddr1
		, OI.INSTL_ADDR4		instAddr2
		, UNIERP5.DBO.FN_DEC(OI.INSTL_TEL_NO)		instTel
		, UNIERP5.DBO.FN_DEC(OI.INSTL_HAND_TEL_NO)	instMobile
		, OI.INSTL_CUST_NM		instCustName
		, CASE WHEN OA.CONT_DT IS NOT NULL THEN '2' ELSE '0' END instreserv
		, OP.WD_CD              outcom
		, (select TOP 1 COLLECT_AMT FROM RENTAL.DBO.R_CONTRACT_RENTAL_SCHD WITH (NOLOCK) WHERE ORDER_NO = OC.ORDER_NO and PAY_FLAG = 'Y' ORDER BY RND_NO DESC) lastOutPayPrice
		FROM RENTAL.DBO.R_ORDER_CONTRACT				OC  (NOLOCK)
		LEFT JOIN RENTAL.DBO.R_ORDER_INSTALL		OI  (NOLOCK) ON (OI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_CONTRACT_ADD	OA  (NOLOCK) ON (OA.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M1  (NOLOCK) ON (M1.MAJOR_CD = 'R1001' AND M1.MINOR_CD = OC.SALES_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_PAYMENT		OP  (NOLOCK) ON (OP.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_BANK 				BK  (NOLOCK) ON (OP.BANK_CD = BK.BANK_CD)
		LEFT JOIN UNIERP5.DBO.B_CARD_CO 			CC  (NOLOCK) ON (OP.BANK_CD = CC.CARD_CO_CD)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M2  (NOLOCK) ON (M2.MAJOR_CD = 'R3011' AND M2.MINOR_CD = OP.PAY_METH)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M3  (NOLOCK) ON (M3.MAJOR_CD = 'R3100' AND M3.MINOR_CD = OC.CONT_STS)
		LEFT JOIN RENTAL.DBO.R_CUSTOMER				CS  (NOLOCK) ON (CS.CUST_NO = OC.CUST_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M4  (NOLOCK) ON (M4.MAJOR_CD = 'R2001' AND M4.MINOR_CD = CS.CUST_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_ITEM           RI  (NOLOCK) ON (OC.ORDER_NO = RI.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_RENTAL_INFO    ORI (NOLOCK) ON (ORI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.V_ORDER_KEY 			VOK WITH(NOEXPAND) ON (VOK.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN (SELECT DISTINCT ORDER_NO  FROM RENTAL.DBO.R_WD_CMS_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CMSR  ON VOK.ORDER_NO = CMSR.ORDER_NO
		LEFT JOIN (SELECT DISTINCT ORDER_NO FROM RENTAL.DBO.R_WD_CARD_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CARDR  ON VOK.ORDER_NO = CARDR.ORDER_NO
		WHERE
		OA.CONT_DT IS NOT NULL	-- 승인일
		AND OC.CONT_STS NOT IN ('36', '40', '42', '43', '47', '55', '75', '80')	-- 계약상태 (해지, 환불, ...)
		AND ISNULL(OC.ORDER_STS, '') NOT IN ('37', '45', 'Z5')
		AND OC.SALES_GRP IN ('1050', '2005', '1054', '1051') -- 롯데하이마트, 쿠팡, 전자랜드, 방방 고객
		AND OI.INSTL_CUST_NM LIKE CONCAT('%', #{name}, '%')
		AND (OI.INSTL_TEL_NO = RENTAL.DBO.FN_ENC(#{phone}) OR OI.INSTL_HAND_TEL_NO = RENTAL.DBO.FN_ENC(#{phone}))
		AND ((OC.ITEM_GROUP_BIG LIKE 'A%' OR OC.ITEM_GROUP_BIG LIKE 'L%' OR OC.ITEM_GROUP_BIG LIKE 'W%' OR OC.ITEM_GROUP_BIG = 'U10000') OR (OC.ITEM_GROUP_BIG LIKE 'B%' AND OC.GOODS_NM LIKE '%GLED%'))
		) INFO
	</select>

	<!-- 사랑체 실고객 ERP DB 체크 -->
	<select id="checkPurchases" parameterType="HashMap" resultType="Hashmap">
		/****************[unierp_customer.checkPurchases]****************/
		SELECT
		DISTINCT
		INFO.orderNo			AS orderNo
		, INFO.contNo			AS contNo
		, INFO.custNo			AS custNo
		, INFO.custName			AS custName
		, INFO.custMobile		AS custMobile
		, INFO.modelCode		AS modelCode
		, INFO.erpModelName		AS erpModelName
		, INFO.saleKind			AS saleKind
		, INFO.saleKindName		AS saleKindName
		, INFO.rentalTerm		AS rentalTerm
		, INFO.rentalTerm		AS serviceMonth
		, INFO.asMonth			AS asMonth
		, INFO.usedTerm			AS usedTerm
		, INFO.receipt			AS receipt
		, INFO.monthlyPayDay	AS monthlyPayDay
		, INFO.bankCd			AS bankCd
		, INFO.acctNo			AS acctNo
		, INFO.acctNo			AS bankNo
		, INFO.bankNm			AS bankNm
		, INFO.payMeth			AS payMeth
		, INFO.panGubun			AS panGubun
		, INFO.instPost			AS instPost
		, INFO.instAddr1		AS instAddr1
		, INFO.instAddr2		AS instAddr2
		, INFO.instTel			AS instTel
		, INFO.instMobile		AS instMobile
		, INFO.instCustName		AS instCustName
		, INFO.outcom			AS outcom
		, INFO.instreserv		AS instreserv
		, INFO.custKind
		, INFO.custKind			AS grpCode
		, CONVERT(VARCHAR(10), INFO.installDate, 121) 		AS installDate
		, CONVERT(VARCHAR(10), INFO.freeAsStartDate, 121) 	AS freeAsStartDate
		, CONVERT(VARCHAR(10), INFO.freeAsEndDate, 121)		AS freeAsEndDate
		, CONVERT(VARCHAR(10), INFO.rentalStartDate, 121)	AS rentalStartDate
		, CONVERT(VARCHAR(10), INFO.rentalEndDate, 121)		AS rentalEndDate
		, CONVERT(INT, INFO.rentalPrice1)					AS rentalPrice1
		, CONVERT(INT, INFO.rentalPrice2)					AS rentalPrice2
		, CONVERT(INT, INFO.totRentalPrice)					AS totRentalPrice
		, CONVERT(INT, INFO.prepayments)					AS prepayments
		FROM   (
		SELECT
		OC.ORDER_NO	orderNo
		, OC.CONT_NO			contNo
		, OC.CUST_NO			custNo
		, CS.CUST_NM			custName
		, UNIERP5.dbo.FN_DEC(CS.HAND_TEL_NO)		custMobile
		, OA.CONT_DT			installDate
		, OC.GOODS_CD			modelCode
		, OC.GOODS_NM			erpModelName
		, OC.SALES_KIND			saleKind
		, M1.MINOR_NM			saleKindName
		, OC.RND1_RENTAL_AMT	rentalPrice1
		, OC.RND2_RENTAL_AMT	rentalPrice2
		, OC.RND1_PAY_AMT		totRentalPrice
		, OC.PREPAY_AMT			prepayments
		, OP.PAY_METH			receipt
		, OP.MONTHLY_PAY_DAY	monthlyPayDay
		, OP.BANK_CD			bankCd
		, CASE WHEN OP.PAY_METH = '1' THEN CC.CARD_CO_NM
		ELSE BK.BANK_NM
		END AS bankNm
		, CASE WHEN OP.PAY_METH = '1' THEN '신용카드'
		WHEN OP.PAY_METH = '2' THEN 'CMS'
		WHEN OP.PAY_METH = '3' THEN '가상계좌'
		WHEN OP.PAY_METH = '4' THEN '지로'
		WHEN OP.PAY_METH = '5' THEN '가수금'
		WHEN OP.PAY_METH = '6' THEN '법인계좌'
		WHEN OP.PAY_METH = '7' THEN '선입금'
		WHEN OP.PAY_METH = '8' THEN '연체입금'
		WHEN OP.PAY_METH = '9' THEN '일반(현금)'
		ELSE OP.PAY_METH
		END AS payMeth
		, REPLICATE('*', LEN(RENTAL.dbo.FN_DEC(OP.ACCT_NO))-4) + RIGHT(RENTAL.dbo.FN_DEC(OP.ACCT_NO), 4) acctNo
		, M2.MINOR_NM			GIRONAME
		, OC.RENTAL_PERIOD		rentalTerm
		, OC.RENTAL_PERIOD		serviceMonth
		, OC.AS_PERIOD			asMonth
		, CASE WHEN (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) >= OC.RENTAL_PERIOD THEN OC.RENTAL_PERIOD ELSE (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) END usedTerm
		, OC.CONT_STS			panGubun
		, M3.MINOR_NM			PAN_GUBUN_NAME
		, OC.RENTAL_FR_DT		freeAsStartDate
		, CASE WHEN ISNUMERIC(OC.AS_PERIOD) = 1 THEN DATEADD(M, OC.AS_PERIOD, OA.CONT_DT - 1) ELSE OC.RENTAL_TO_DT END freeAsEndDate
		, OC.RENTAL_FR_DT		rentalStartDate
		, OC.RENTAL_TO_DT		rentalEndDate
		, CASE WHEN OC.ITEM_GROUP_BIG LIKE 'A%' THEN 'M'	-- chair
		WHEN OC.ITEM_GROUP_BIG LIKE 'L%' THEN 'L'	-- lacloud
		WHEN OC.ITEM_GROUP_BIG LIKE 'W%' THEN 'W'	-- Water
		WHEN OC.ITEM_GROUP_BIG LIKE 'B%' THEN 'G'	-- BTN GLED
		WHEN OC.ITEM_GROUP_BIG = 'U11000' THEN 'BB'	-- 생활가전 블롬베르크
		ELSE OC.ITEM_GROUP_BIG
		END custKind
		, OI.INSTL_ZIP_CD		instPost
		, CONCAT(OI.INSTL_ADDR1, ' ', OI.INSTL_ADDR2, ' ', OI.INSTL_ADDR3) instAddr1
		, OI.INSTL_ADDR4		instAddr2
		, UNIERP5.DBO.FN_DEC(OI.INSTL_TEL_NO)		instTel
		, UNIERP5.DBO.FN_DEC(OI.INSTL_HAND_TEL_NO)	instMobile
		, OI.INSTL_CUST_NM		instCustName
		, CASE WHEN OA.CONT_DT IS NOT NULL THEN '2' ELSE '0' END instreserv
		, OP.WD_CD              outcom
		,
		(select TOP 1 COLLECT_AMT FROM RENTAL.DBO.R_CONTRACT_RENTAL_SCHD WITH (NOLOCK) WHERE ORDER_NO = OC.ORDER_NO
		and PAY_FLAG = 'Y' ORDER BY RND_NO DESC) lastOutPayPrice
		FROM RENTAL.DBO.R_ORDER_CONTRACT				OC  (NOLOCK)
		LEFT JOIN RENTAL.DBO.R_ORDER_INSTALL		OI  (NOLOCK) ON (OI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_CONTRACT_ADD	OA  (NOLOCK) ON (OA.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M1  (NOLOCK) ON (M1.MAJOR_CD = 'R1001' AND M1.MINOR_CD = OC.SALES_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_PAYMENT		OP  (NOLOCK) ON (OP.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_BANK 				BK  (NOLOCK) ON (OP.BANK_CD = BK.BANK_CD)
		LEFT JOIN UNIERP5.DBO.B_CARD_CO 			CC  (NOLOCK) ON (OP.BANK_CD = CC.CARD_CO_CD)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M2  (NOLOCK) ON (M2.MAJOR_CD = 'R3011' AND M2.MINOR_CD = OP.PAY_METH)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M3  (NOLOCK) ON (M3.MAJOR_CD = 'R3100' AND M3.MINOR_CD = OC.CONT_STS)
		LEFT JOIN RENTAL.DBO.R_CUSTOMER				CS  (NOLOCK) ON (CS.CUST_NO = OC.CUST_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M4  (NOLOCK) ON (M4.MAJOR_CD = 'R2001' AND M4.MINOR_CD = CS.CUST_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_ITEM           RI  (NOLOCK) ON (OC.ORDER_NO = RI.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_RENTAL_INFO    ORI (NOLOCK) ON (ORI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.V_ORDER_KEY 			VOK WITH(NOEXPAND) ON (VOK.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN (SELECT DISTINCT ORDER_NO  FROM RENTAL.DBO.R_WD_CMS_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CMSR  ON VOK.ORDER_NO = CMSR.ORDER_NO
		LEFT JOIN (SELECT DISTINCT ORDER_NO FROM RENTAL.DBO.R_WD_CARD_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CARDR  ON VOK.ORDER_NO = CARDR.ORDER_NO
		WHERE
		OA.APROV_DT IS NOT NULL	-- 승인일
		AND OC.CONT_STS NOT IN ('36', '40', '42', '43', '47', '55', '75', '80')	-- 계약상태 (해지, 환불, ...)
		AND ISNULL(OC.ORDER_STS, '') NOT IN ('37', '45', 'Z5')
		AND OC.SALES_GRP NOT IN ('1050', '2005', '1054', '1051') -- 롯데하이마트, 쿠팡, 전자랜드, 방방 고객 아닌것
		AND CS.CUST_NM LIKE CONCAT('%', #{name}, '%')
		AND (CS.TEL_NO = RENTAL.DBO.FN_ENC(#{phone}) OR CS.HAND_TEL_NO = RENTAL.DBO.FN_ENC(#{phone}))
		AND ((OC.ITEM_GROUP_BIG LIKE 'A%' OR OC.ITEM_GROUP_BIG LIKE 'L%' OR OC.ITEM_GROUP_BIG LIKE 'W%' OR OC.ITEM_GROUP_BIG = 'U10000') OR (OC.ITEM_GROUP_BIG LIKE 'B%' AND OC.GOODS_NM LIKE '%GLED%'))
		UNION ALL
		SELECT
		OC.ORDER_NO	orderNo
		, OC.CONT_NO			contNo
		, OC.CUST_NO			custNo
		, OI.INSTL_CUST_NM			custName
		, UNIERP5.dbo.FN_DEC(OI.INSTL_HAND_TEL_NO)		custMobile
		, OA.CONT_DT			installDate
		, OC.GOODS_CD			modelCode
		, OC.GOODS_NM			erpModelName
		, OC.SALES_KIND			saleKind
		, M1.MINOR_NM			saleKindName
		, OC.RND1_RENTAL_AMT	rentalPrice1
		, OC.RND2_RENTAL_AMT	rentalPrice2
		, OC.RND1_PAY_AMT		totRentalPrice
		, OC.PREPAY_AMT			prepayments
		, OP.PAY_METH			receipt
		, OP.MONTHLY_PAY_DAY	monthlyPayDay
		, OP.BANK_CD			bankCd
		, CASE WHEN OP.PAY_METH = '1' THEN CC.CARD_CO_NM
		ELSE BK.BANK_NM
		END AS bankNm
		, CASE WHEN OP.PAY_METH = '1' THEN '신용카드'
		WHEN OP.PAY_METH = '2' THEN 'CMS'
		WHEN OP.PAY_METH = '3' THEN '가상계좌'
		WHEN OP.PAY_METH = '4' THEN '지로'
		WHEN OP.PAY_METH = '5' THEN '가수금'
		WHEN OP.PAY_METH = '6' THEN '법인계좌'
		WHEN OP.PAY_METH = '7' THEN '선입금'
		WHEN OP.PAY_METH = '8' THEN '연체입금'
		WHEN OP.PAY_METH = '9' THEN '일반(현금)'
		ELSE OP.PAY_METH
		END AS payMeth
		, REPLICATE('*', LEN(RENTAL.dbo.FN_DEC(OP.ACCT_NO))-4) + RIGHT(RENTAL.dbo.FN_DEC(OP.ACCT_NO), 4) acctNo
		, M2.MINOR_NM			GIRONAME
		, OC.RENTAL_PERIOD		rentalTerm
		, OC.RENTAL_PERIOD		serviceMonth
		, OC.AS_PERIOD			asMonth
		, CASE WHEN (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) >= OC.RENTAL_PERIOD THEN OC.RENTAL_PERIOD ELSE (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) END usedTerm
		, OC.CONT_STS			panGubun
		, M3.MINOR_NM			PAN_GUBUN_NAME
		, OC.RENTAL_FR_DT		freeAsStartDate
		, CASE WHEN ISNUMERIC(OC.AS_PERIOD) = 1 THEN DATEADD(M, OC.AS_PERIOD, OA.CONT_DT - 1) ELSE OC.RENTAL_TO_DT END freeAsEndDate
		, OC.RENTAL_FR_DT		rentalStartDate
		, OC.RENTAL_TO_DT		rentalEndDate
		, CASE WHEN OC.ITEM_GROUP_BIG LIKE 'A%' THEN 'M'	-- chair
		WHEN OC.ITEM_GROUP_BIG LIKE 'L%' THEN 'L'	-- lacloud
		WHEN OC.ITEM_GROUP_BIG LIKE 'W%' THEN 'W'	-- Water
		WHEN OC.ITEM_GROUP_BIG LIKE 'B%' THEN 'G'	-- BTN GLED
		WHEN OC.ITEM_GROUP_BIG = 'U11000' THEN 'BB'	-- 생활가전 블롬베르크
		ELSE OC.ITEM_GROUP_BIG
		END custKind
		, OI.INSTL_ZIP_CD		instPost
		, CONCAT(OI.INSTL_ADDR1, ' ', OI.INSTL_ADDR2, ' ', OI.INSTL_ADDR3) instAddr1
		, OI.INSTL_ADDR4		instAddr2
		, UNIERP5.DBO.FN_DEC(OI.INSTL_TEL_NO)		instTel
		, UNIERP5.DBO.FN_DEC(OI.INSTL_HAND_TEL_NO)	instMobile
		, OI.INSTL_CUST_NM		instCustName
		, CASE WHEN OA.CONT_DT IS NOT NULL THEN '2' ELSE '0' END instreserv
		, OP.WD_CD              outcom
		,
		(select TOP 1 COLLECT_AMT FROM RENTAL.DBO.R_CONTRACT_RENTAL_SCHD WITH (NOLOCK) WHERE ORDER_NO = OC.ORDER_NO
		and PAY_FLAG = 'Y' ORDER BY RND_NO DESC) lastOutPayPrice
		FROM RENTAL.DBO.R_ORDER_CONTRACT				OC  (NOLOCK)
		LEFT JOIN RENTAL.DBO.R_ORDER_INSTALL		OI  (NOLOCK) ON (OI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_CONTRACT_ADD	OA  (NOLOCK) ON (OA.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M1  (NOLOCK) ON (M1.MAJOR_CD = 'R1001' AND M1.MINOR_CD = OC.SALES_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_PAYMENT		OP  (NOLOCK) ON (OP.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_BANK 				BK  (NOLOCK) ON (OP.BANK_CD = BK.BANK_CD)
		LEFT JOIN UNIERP5.DBO.B_CARD_CO 			CC  (NOLOCK) ON (OP.BANK_CD = CC.CARD_CO_CD)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M2  (NOLOCK) ON (M2.MAJOR_CD = 'R3011' AND M2.MINOR_CD = OP.PAY_METH)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M3  (NOLOCK) ON (M3.MAJOR_CD = 'R3100' AND M3.MINOR_CD = OC.CONT_STS)
		LEFT JOIN RENTAL.DBO.R_CUSTOMER				CS  (NOLOCK) ON (CS.CUST_NO = OC.CUST_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M4  (NOLOCK) ON (M4.MAJOR_CD = 'R2001' AND M4.MINOR_CD = CS.CUST_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_ITEM           RI  (NOLOCK) ON (OC.ORDER_NO = RI.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_RENTAL_INFO    ORI (NOLOCK) ON (ORI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.V_ORDER_KEY 			VOK WITH(NOEXPAND) ON (VOK.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN (SELECT DISTINCT ORDER_NO  FROM RENTAL.DBO.R_WD_CMS_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CMSR  ON VOK.ORDER_NO = CMSR.ORDER_NO
		LEFT JOIN (SELECT DISTINCT ORDER_NO FROM RENTAL.DBO.R_WD_CARD_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CARDR  ON VOK.ORDER_NO = CARDR.ORDER_NO
		WHERE
		OA.APROV_DT IS NOT NULL	-- 승인일
		AND OC.CONT_STS NOT IN ('36', '40', '42', '43', '47', '55', '75', '80')	-- 계약상태 (해지, 환불, ...)
		AND ISNULL(OC.ORDER_STS, '') NOT IN ('37', '45', 'Z5')
		AND OC.SALES_GRP NOT IN ('1050', '2005', '1054', '1051') -- 롯데하이마트, 쿠팡, 전자랜드, 방방 고객 아닌것
		AND OI.INSTL_CUST_NM LIKE CONCAT('%', #{name}, '%')
		AND (OI.INSTL_TEL_NO = RENTAL.DBO.FN_ENC(#{phone}) OR OI.INSTL_HAND_TEL_NO = RENTAL.DBO.FN_ENC(#{phone}))
		AND ((OC.ITEM_GROUP_BIG LIKE 'A%' OR OC.ITEM_GROUP_BIG LIKE 'L%' OR OC.ITEM_GROUP_BIG LIKE 'W%' OR OC.ITEM_GROUP_BIG = 'U10000') OR (OC.ITEM_GROUP_BIG LIKE 'B%' AND OC.GOODS_NM LIKE '%GLED%'))
		UNION ALL
		/* 하이마트, 쿠팡, 전자랜드, 방방 */
		SELECT
		OC.ORDER_NO	orderNo
		, OC.CONT_NO			contNo
		, OC.CUST_NO			custNo
		, OI.INSTL_CUST_NM			custName
		, UNIERP5.dbo.FN_DEC(OI.INSTL_HAND_TEL_NO)		custMobile
		, OA.CONT_DT			installDate
		, OC.GOODS_CD			modelCode
		, OC.GOODS_NM			erpModelName
		, OC.SALES_KIND			saleKind
		, M1.MINOR_NM			saleKindName
		, OC.RND1_RENTAL_AMT	rentalPrice1
		, OC.RND2_RENTAL_AMT	rentalPrice2
		, OC.RND1_PAY_AMT		totRentalPrice
		, OC.PREPAY_AMT			prepayments
		, OP.PAY_METH			receipt
		, OP.MONTHLY_PAY_DAY	monthlyPayDay
		, OP.BANK_CD			bankCd
		, CASE WHEN OP.PAY_METH = '1' THEN CC.CARD_CO_NM
		ELSE BK.BANK_NM
		END AS bankNm
		, CASE WHEN OP.PAY_METH = '1' THEN '신용카드'
		WHEN OP.PAY_METH = '2' THEN 'CMS'
		WHEN OP.PAY_METH = '3' THEN '가상계좌'
		WHEN OP.PAY_METH = '4' THEN '지로'
		WHEN OP.PAY_METH = '5' THEN '가수금'
		WHEN OP.PAY_METH = '6' THEN '법인계좌'
		WHEN OP.PAY_METH = '7' THEN '선입금'
		WHEN OP.PAY_METH = '8' THEN '연체입금'
		WHEN OP.PAY_METH = '9' THEN '일반(현금)'
		ELSE OP.PAY_METH
		END AS payMeth
		, REPLICATE('*', LEN(RENTAL.dbo.FN_DEC(OP.ACCT_NO))-4) + RIGHT(RENTAL.dbo.FN_DEC(OP.ACCT_NO), 4) acctNo
		, M2.MINOR_NM			GIRONAME
		, OC.RENTAL_PERIOD		rentalTerm
		, OC.RENTAL_PERIOD		serviceMonth
		, OC.AS_PERIOD			asMonth
		, CASE WHEN (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) >= OC.RENTAL_PERIOD THEN OC.RENTAL_PERIOD ELSE (DATEDIFF(MM, OC.RENTAL_FR_DT, CONVERT(VARCHAR, GETDATE(), 121)) + 1) END usedTerm
		, OC.CONT_STS			panGubun
		, M3.MINOR_NM			PAN_GUBUN_NAME
		, OC.RENTAL_FR_DT		freeAsStartDate
		, CASE WHEN ISNUMERIC(OC.AS_PERIOD) = 1 THEN DATEADD(M, OC.AS_PERIOD, OA.CONT_DT - 1) ELSE OC.RENTAL_TO_DT END freeAsEndDate
		, OC.RENTAL_FR_DT		rentalStartDate
		, OC.RENTAL_TO_DT		rentalEndDate
		, CASE WHEN OC.ITEM_GROUP_BIG LIKE 'A%' THEN 'M'	-- chair
		WHEN OC.ITEM_GROUP_BIG LIKE 'L%' THEN 'L'	-- lacloud
		WHEN OC.ITEM_GROUP_BIG LIKE 'W%' THEN 'W'	-- Water
		WHEN OC.ITEM_GROUP_BIG LIKE 'B%' THEN 'G'	-- BTN GLED
		WHEN OC.ITEM_GROUP_BIG = 'U11000' THEN 'BB'	-- 생활가전 블롬베르크
		ELSE OC.ITEM_GROUP_BIG
		END custKind
		, OI.INSTL_ZIP_CD		instPost
		, CONCAT(OI.INSTL_ADDR1, ' ', OI.INSTL_ADDR2, ' ', OI.INSTL_ADDR3) instAddr1
		, OI.INSTL_ADDR4		instAddr2
		, UNIERP5.DBO.FN_DEC(OI.INSTL_TEL_NO)		instTel
		, UNIERP5.DBO.FN_DEC(OI.INSTL_HAND_TEL_NO)	instMobile
		, OI.INSTL_CUST_NM		instCustName
		, CASE WHEN OA.CONT_DT IS NOT NULL THEN '2' ELSE '0' END instreserv
		, OP.WD_CD              outcom
		, (select TOP 1 COLLECT_AMT FROM RENTAL.DBO.R_CONTRACT_RENTAL_SCHD WITH (NOLOCK) WHERE ORDER_NO = OC.ORDER_NO and PAY_FLAG = 'Y' ORDER BY RND_NO DESC) lastOutPayPrice
		FROM RENTAL.DBO.R_ORDER_CONTRACT				OC  (NOLOCK)
		LEFT JOIN RENTAL.DBO.R_ORDER_INSTALL		OI  (NOLOCK) ON (OI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_CONTRACT_ADD	OA  (NOLOCK) ON (OA.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M1  (NOLOCK) ON (M1.MAJOR_CD = 'R1001' AND M1.MINOR_CD = OC.SALES_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_PAYMENT		OP  (NOLOCK) ON (OP.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_BANK 				BK  (NOLOCK) ON (OP.BANK_CD = BK.BANK_CD)
		LEFT JOIN UNIERP5.DBO.B_CARD_CO 			CC  (NOLOCK) ON (OP.BANK_CD = CC.CARD_CO_CD)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M2  (NOLOCK) ON (M2.MAJOR_CD = 'R3011' AND M2.MINOR_CD = OP.PAY_METH)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M3  (NOLOCK) ON (M3.MAJOR_CD = 'R3100' AND M3.MINOR_CD = OC.CONT_STS)
		LEFT JOIN RENTAL.DBO.R_CUSTOMER				CS  (NOLOCK) ON (CS.CUST_NO = OC.CUST_NO)
		LEFT JOIN UNIERP5.DBO.B_MINOR				M4  (NOLOCK) ON (M4.MAJOR_CD = 'R2001' AND M4.MINOR_CD = CS.CUST_KIND)
		LEFT JOIN RENTAL.DBO.R_ORDER_ITEM           RI  (NOLOCK) ON (OC.ORDER_NO = RI.ORDER_NO)
		LEFT JOIN RENTAL.DBO.R_ORDER_RENTAL_INFO    ORI (NOLOCK) ON (ORI.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN RENTAL.DBO.V_ORDER_KEY 			VOK WITH(NOEXPAND) ON (VOK.ORDER_NO = OC.ORDER_NO)
		LEFT JOIN (SELECT DISTINCT ORDER_NO  FROM RENTAL.DBO.R_WD_CMS_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CMSR  ON VOK.ORDER_NO = CMSR.ORDER_NO
		LEFT JOIN (SELECT DISTINCT ORDER_NO FROM RENTAL.DBO.R_WD_CARD_RESULT (NOLOCK) WHERE REFLECT_FLAG IS NULL) AS CARDR  ON VOK.ORDER_NO = CARDR.ORDER_NO
		WHERE
		OA.CONT_DT IS NOT NULL	-- 승인일
		AND OC.CONT_STS NOT IN ('36', '40', '42', '43', '47', '55', '75', '80')	-- 계약상태 (해지, 환불, ...)
		AND ISNULL(OC.ORDER_STS, '') NOT IN ('37', '45', 'Z5')
		AND OC.SALES_GRP IN ('1050', '2005', '1054', '1051') -- 롯데하이마트, 쿠팡, 전자랜드, 방방 고객
		AND OI.INSTL_CUST_NM LIKE CONCAT('%', #{name}, '%')
		AND (OI.INSTL_TEL_NO = RENTAL.DBO.FN_ENC(#{phone}) OR OI.INSTL_HAND_TEL_NO = RENTAL.DBO.FN_ENC(#{phone}))
		AND ((OC.ITEM_GROUP_BIG LIKE 'A%' OR OC.ITEM_GROUP_BIG LIKE 'L%' OR OC.ITEM_GROUP_BIG LIKE 'W%' OR OC.ITEM_GROUP_BIG = 'U10000') OR (OC.ITEM_GROUP_BIG LIKE 'B%' AND OC.GOODS_NM LIKE '%GLED%'))
		) INFO
	</select>

	<!-- 간편배송 상세 UNIERP -->
	<select id="selectDeliveryInfoUNIERP" parameterType="hashmap" resultType="hashmap">
		/****************[unierp_customer.selectDeliveryInfoUNIERP]****************/
		SELECT TOP 1
		A.SHIPPING_NO											AS SHIPPING_SEQ
		,CASE
		WHEN A.EXT1_CD IS NOT NULL AND A.EXT1_CD != ''THEN A.EXT1_CD
		ELSE A.ORDER_NO
		END 													AS BODY_NO
		,A.SHIPPING_TYPE
		,A.RECEIVE_DT											AS RECEIVE_DATE
		,A.CUST_NM												AS CUST_NAME
		,A.ADDR1 + ' ' + A.ADDR2 + ' ' + A.ADDR3 + ' ' + A.ADDR4 AS INSADDR
		,A.ADDR1 + ' ' + A.ADDR2 + ' ' + A.ADDR3 AS ADDR1
		,A.ADDR4 AS ADDR2
		,a.ZIP_CD as ZIP_CD
		,A.TEL_NO
		,A.HAND_TEL_NO											AS HPHONE_NO
		,CASE
		WHEN A.PROD_GROUP_CD = 'A10000' THEN 'M'
		WHEN A.PROD_GROUP_CD = 'L10000' THEN 'L'
		WHEN A.PROD_GROUP_CD = 'W10000' THEN 'W'
		ELSE ''
		END														AS PRODUCT_TYPE
		,A.GOODS_CD												AS PRODUCT_CODE
		,A.GOODS_NM												AS PRODUCT_NAME
		,''														AS COLORTYPE
		,A.CALLER_ID												AS PURCHASING_OFFICE <!-- 코드값 변경됨 -->
		,A.STATUS_CD												AS INS_COMPLETE
		,A.SERVICE_MONTH
		,A.DIV_STATUS
		,A.DRIVER_ID1											AS DELIVERYMAN1
		,A.DRIVER_ID2											AS DELIVERYMAN2
		,A.PROMISE_YN											AS PROMISE
		,A.PROMISE_TIME

		,B.DRIVER_NM				AS GISA_NAME
		,B.HAND_TEL_NO				AS GISA_TELNO
		,CONVERT(VARCHAR(10), A.APPLY_DT, 120) AS DUE_DATE
		,CONVERT(VARCHAR(10), A.DIV_DT, 120) AS DIV_DATE
		FROM RENTAL.DBO.R_SHIPPING_INFO A WITH (NOLOCK)
		LEFT JOIN RENTAL.DBO.R_DRIVER_MASTER B ON A.DRIVER_ID1 = B.DRIVER_ID
		<where>
			<trim prefix="(" prefixOverrides="OR" suffix=")">
				(A.HAND_TEL_NO= #{telNum} OR A.TEL_NO = #{telNum})
			</trim>
			AND
			<trim prefix="(" prefixOverrides="OR" suffix=")">
				(A.ORDER_NO = #{custNum} OR A.CUST_NM = #{custNum} OR A.EXT1_CD = #{custNum})
			</trim>
			AND A.DEL_FLAG = 'N'
		</where>
		<!-- ORDER BY SHIPPING_SEQ DESC -->
		ORDER BY RECEIVE_DATE DESC, DUE_DATE DESC
	</select>

	<!-- 배송 주소 이력 INSERT -->
	<insert id="insertHistoryDataUNIERP" parameterType="hashmap">
		/****************[unierp_customer.insertHistoryDataUNIERP]****************/
		DECLARE @AA DATETIME
		SET @AA = #{expectDt}

		IF @AA = ''
		BEGIN
		SET @AA = NULL
		END

		INSERT INTO RENTAL.DBO.R_SHIPPING_CHANGE_HISTORY (
		SHIPPING_NO
		, SEQ
		, APPLY_DT
		, CHANGE_APPLY_DT
		, APPLY_CHANGE_DESC
		, INSRT_USER_ID
		, INSRT_DT
		, UPDT_USER_ID
		, UPDT_DT
		<if test="date_reason != null and date_reason != '' ">
			, EXT1_CD
		</if>
		)
		VALUES (
		#{shipSeq} ,
		(SELECT ISNULL(MAX(SEQ),0)+1 FROM RENTAL.DBO.R_SHIPPING_CHANGE_HISTORY (NOLOCK) WHERE SHIPPING_NO = #{shipSeq} ) ,
		( SELECT APPLY_DT FROM RENTAL.DBO.R_SHIPPING_INFO (NOLOCK) WHERE SHIPPING_NO = #{shipSeq}) ,
		@AA
		,'고객 변경건'
		,'homepage'
		,GETDATE()
		,'homepage'
		,GETDATE()
		<if test="date_reason != null and date_reason != '' ">
			,#{date_reason}
		</if>

		)
	</insert>

	<!-- 간편배송 인증 UNIERP-->
	<select id="selectDeliveryAuthUNIERP" parameterType="hashmap" resultType="int">
		/****************[unierp_customer.selectDeliveryAuthUNIERP]****************/
		SELECT
		COUNT(*) as cnt
		FROM RENTAL.DBO.R_SHIPPING_INFO WITH (NOLOCK)
		<where>
			<trim prefix="(" prefixOverrides="OR" suffix=")">
				(HAND_TEL_NO = #{telNumber} OR TEL_NO = #{telNumber})
			</trim>
			AND
			<trim prefix="(" prefixOverrides="OR" suffix=")">
				(ORDER_NO = #{custNumber} OR CUST_NM = #{custNumber} OR EXT1_CD = #{custNumber})
			</trim>
		</where>
	</select>

	<!-- 사은품 관련 정보 조회  UNIERP-->
	<select id="selectGiftInfoUNIERP" parameterType="hashmap" resultType="hashmap">
		/****************[unierp_customer.selectGiftInfoUNIERP]****************/
		SELECT TOP 1
		A.ORDER_NO AS CUSTCODE
		,B.ADDR1 + B.ADDR2 + B.ADDR3 AS GIFTADDR1
		,B.ADDR4	 AS GIFTADDR2
		FROM RENTAL.DBO.R_ORDER_CONTRACT A WITH (NOLOCK)
		LEFT JOIN RENTAL.dbo.R_ORDER_GIFT B WITH (NOLOCK) ON A.ORDER_NO = B.ORDER_NO
		WHERE B.CUST_NM = #{custName}
		<if test="telNo !=null and telNo !=''">
			AND (B.TEL_NO = UNIERP5.dbo.FN_ENC(#{telNo}) OR B.HAND_TEL_NO = UNIERP5.dbo.FN_ENC(#{telNo}))
		</if>
		<if test="hphoneNo !=null and hphoneNo !=''">
			AND (B.TEL_NO = UNIERP5.dbo.FN_ENC(#{hphoneNo}) OR B.HAND_TEL_NO = UNIERP5.dbo.FN_ENC(#{hphoneNo}))
		</if>
		ORDER BY A.INSRT_DT DESC
	</select>

	<!-- 배송일 지정 및 주소변경 UNIERP -->
	<update id="updateCustInfoUNIERP" parameterType="hashmap">
		/****************[unierp_customer.updateCustInfoUNIERP]****************/
		UPDATE RENTAL.DBO.R_SHIPPING_INFO
		SET
		APPLY_DT		 = #{expectDt}
		<if test="zipCd!=null and zipCd!=''">
			,ZIP_CD        = #{zipCd}
		</if>
		<if test="newAddr1!=null and newAddr1!=''">
			,ADDR1         = #{newAddr1}
		</if>
		<if test="newAddr2!=null and newAddr2!=''">
			,ADDR2         = #{newAddr2}
		</if>
		<if test="newAddr3!= null and newAddr3!=''">
			,ADDR3         = #{newAddr3}
		</if>
		<if test="newAddr4!= null and newAddr4!=''">
			,ADDR4         = #{newAddr4}
		</if>
		<if test="area!=null and area!=''">
			,AREA_CD       = #{area}
		</if>
		,UPDT_USER_ID	 = 'shipadmin'
		,UPDT_DT    	 = GETDATE()
		,CHANGE_FLAG	 = 'Y'  			<!--  고객 업데이트 -->
		,HEDOFC_REMARK = concat((select HEDOFC_REMARK from RENTAL.dbo.R_SHIPPING_INFO WITH (NOLOCK) where SHIPPING_NO = #{shipSeq}), '//' , #{companyCheck})		<!-- 이력에 추가  -->
		,REMARK        = concat((select REMARK from RENTAL.dbo.R_SHIPPING_INFO WITH (NOLOCK) where SHIPPING_NO = #{shipSeq}), ' ' ,'설치정보변경 :  (',convert(varchar , getdate() , 23),',고객변경)')		<!-- 이력에 추가  -->
		WHERE
		SHIPPING_NO       = #{shipSeq}
	</update>

	<!-- 사은품 주소 변경 UNIERP -->
	<update id="updateGiftAddrUNIERP" parameterType="hashmap">
		/****************[unierp_customer.updateGiftAddrUNIERP]****************/
		UPDATE RENTAL.DBO.R_ORDER_GIFT
		SET
		UPDT_DT = GETDATE()
		<if test="zipCd !=null and zipCd !=''">
			,ZIP_CD  = #{zipCd}
		</if>
		<if test="newAddr1 !=null and newAddr1 !=''">
			,ADDR1   = #{newAddr1}
		</if>
		<if test="newAddr2 !=null and newAddr2 !=''">
			,ADDR2   = #{newAddr2}
		</if>
		<if test="newAddr3 !=null and newAddr3 !=''">
			,ADDR3   = #{newAddr3}
		</if>
		<if test="newAddr4 !=null and newAddr4 !=''">
			,ADDR4   = #{newAddr4}
		</if>
		WHERE ORDER_NO    = #{custCode}
	</update>

	<!-- 전시장 체험 예약 접수 후 ERP 등록 -->
	<select id="LMSendApi" statementType="CALLABLE" parameterType="hashmap" resultType="hashmap">
		/****************[unierp_customer.LMSendApi]****************/
		{CALL RENTAL.dbo.usp_R_LM_SEND_HOMEPAGE (
		#{SHIPPING_NO, jdbcType=NVARCHAR, mode=IN}
		)}
	</select>

	<!-- 간편 배송 조회 인증 리스트 -->
	<select id="selectOdrNumList" resultType="HashMap" parameterType="HashMap">
		/****************[unierp_customer.selectOdrNumList]****************/
		SELECT DISTINCT
		GOODS_NM , ORDER_NO
		FROM RENTAL.DBO.R_SHIPPING_INFO WITH (NOLOCK)
		WHERE ( (HAND_TEL_NO = UNIERP5.dbo.FN_ENC(#{telNumber}) OR TEL_NO = UNIERP5.dbo.FN_ENC(#{telNumber})) )
		AND
		( (ORDER_NO = #{orderNum} OR CUST_NM = #{orderNum} OR EXT1_CD = #{orderNum}) )
		AND STATUS_CD NOT IN ('ZZ','X1','X2','X3','X4','F1','F2')
		AND SHIPPING_TYPE IN ('D010','P040')
		AND ISNULL(TRANS_FLAG,'2') != 1
	</select>

	<!-- 후기작성 인증 리스트 -->
	<select id="selectOdrNumReviewList" resultType="HashMap" parameterType="HashMap">
		/****************[unierp_customer.selectOdrNumReviewList]****************/
		SELECT DISTINCT
		GOODS_NM , A.ORDER_NO  , STATUS_CD , GOODS_CD
		FROM RENTAL.DBO.R_SHIPPING_INFO A WITH (NOLOCK)
		INNER JOIN R_ORDER_INSTALL (NOLOCK) D ON A.ORDER_NO = D.ORDER_NO
		WHERE
		(RENTAL.DBO.FN_DEC(D.INSTL_HAND_TEL_NO) = #{telNumber} OR RENTAL.DBO.FN_DEC(D.INSTL_TEL_NO) = #{telNumber} )
		AND D.INSTL_CUST_NM = #{orderNum}
		AND SHIPPING_TYPE IN ('D010','P040')
		AND ISNULL(TRANS_FLAG,'2') != 1
		AND DEL_FLAG = 'N'
		UNION ALL
		SELECT DISTINCT
		GOODS_NM , A.ORDER_NO  , 'ZZ' AS STATUS_CD , GOODS_CD
		FROM RENTAL.DBO.R_ORDER_CONTRACT A (NOLOCK) LEFT JOIN RENTAL.DBO.R_ORDER_CUST_INFO B (NOLOCK)
		ON A.ORDER_NO = B.ORDER_NO
		WHERE 1=1
		AND A.CUST_NM = #{orderNum}
		AND A.EXT2_CD = 'COUPANG'
		AND (B.HAND_TEL_NO = UNIERP5.dbo.FN_ENC(#{telNumber}) OR B.TEL_NO = UNIERP5.dbo.FN_ENC(#{telNumber}) OR B.ETC_TEL_NO = UNIERP5.dbo.FN_ENC(#{telNumber}))

		UNION ALL

		SELECT DISTINCT GOODS_NM , A.ORDER_NO  , 'ZZ' AS STATUS_CD , GOODS_CD FROM R_ORDER_ITEM A(NOLOCK)  LEFT JOIN R_ORDER_CONTRACT B (NOLOCK)
		ON A.ORDER_NO = B.ORDER_NO
		WHERE 1=1
		AND A.ORDER_NO IN (
		SELECT ORDER_NO FROM R_ORDER_CUST_INFO B (NOLOCK)
		WHERE 1=1
		AND (RENTAL.DBO.FN_DEC(B.TEL_NO) = #{telNumber} OR RENTAL.DBO.FN_DEC(B.HAND_TEL_NO) = #{telNumber} )
		AND B.CUST_NM = #{orderNum}
		)
		AND SEND_DT IS NOT NULL
		AND ITEM_STATUS = 'C'
	</select>

	<select id="selectMedicalReviewChkList" resultType="HashMap" parameterType="HashMap">
		/****************[unierp_customer.selectMedicalReviewChkList]****************/
		SELECT COUNT(*) AS mCnt
		FROM RENTAL.dbo.R_GOODS_MEDICAL (NOLOCK)
		WHERE 1=1
		AND GOODS_CD = #{GOODS_CD}
		AND USE_YN = 'Y'
	</select>

</mapper>